<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pyfoma.private.regexparse &#8212; PyFoma 1.0.7 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=27fed22d" />
    <script src="../../../_static/documentation_options.js?v=46dfa7f5"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pyfoma.private.regexparse</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">re</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pyre</span><span class="o">,</span><span class="w"> </span><span class="nn">functools</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyfoma.fst</span><span class="w"> </span><span class="kn">import</span> <span class="n">FST</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyfoma.algorithms</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">alg</span>


<div class="viewcode-block" id="RegexParse">
<a class="viewcode-back" href="../../../pyfoma.private.html#pyfoma.private.regexparse.RegexParse">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RegexParse</span><span class="p">:</span>
    <span class="n">shortops</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;|&#39;</span><span class="p">:</span> <span class="s1">&#39;UNION&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span> <span class="s1">&#39;MINUS&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">:</span> <span class="s1">&#39;INTERSECTION&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span> <span class="s1">&#39;STAR&#39;</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span> <span class="s1">&#39;PLUS&#39;</span><span class="p">,</span>
                <span class="s1">&#39;(&#39;</span><span class="p">:</span> <span class="s1">&#39;LPAREN&#39;</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">:</span> <span class="s1">&#39;RPAREN&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">:</span> <span class="s1">&#39;OPTIONAL&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">:</span> <span class="s1">&#39;CP&#39;</span><span class="p">,</span> <span class="s1">&#39;:?&#39;</span><span class="p">:</span> <span class="s1">&#39;CPOPTIONAL&#39;</span><span class="p">,</span>
                <span class="s1">&#39;~&#39;</span><span class="p">:</span> <span class="s2">&quot;COMPLEMENT&quot;</span><span class="p">,</span> <span class="s1">&#39;@&#39;</span><span class="p">:</span> <span class="s2">&quot;COMPOSE&quot;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">:</span> <span class="s1">&#39;COMMA&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span> <span class="s1">&#39;CONTEXT&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span> <span class="s1">&#39;PAIRUP&#39;</span><span class="p">}</span>

    <span class="c1"># Used to set names so that these functions have useful error messages</span>
    <span class="n">_builtins_project_lambda</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">alg</span><span class="o">.</span><span class="n">projected</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dim&#39;</span><span class="p">,</span> <span class="s1">&#39;-1&#39;</span><span class="p">)))</span>
    <span class="n">_builtins_project_lambda</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s2">&quot;project&quot;</span>
    <span class="n">_builtins_input_lambda</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">alg</span><span class="o">.</span><span class="n">projected</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">_builtins_input_lambda</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s2">&quot;input&quot;</span>
    <span class="n">_builtins_output_lambda</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">alg</span><span class="o">.</span><span class="n">projected</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">_builtins_output_lambda</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s2">&quot;output&quot;</span>

    <span class="n">builtins</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;reverse&#39;</span><span class="p">:</span> <span class="n">alg</span><span class="o">.</span><span class="n">reversed</span><span class="p">,</span>
                <span class="s1">&#39;invert&#39;</span><span class="p">:</span> <span class="n">alg</span><span class="o">.</span><span class="n">inverted</span><span class="p">,</span>
                <span class="s1">&#39;minimize&#39;</span><span class="p">:</span> <span class="n">alg</span><span class="o">.</span><span class="n">minimized</span><span class="p">,</span>
                <span class="s1">&#39;determinize&#39;</span><span class="p">:</span> <span class="n">alg</span><span class="o">.</span><span class="n">determinized</span><span class="p">,</span>
                <span class="s1">&#39;ignore&#39;</span><span class="p">:</span> <span class="n">alg</span><span class="o">.</span><span class="n">ignore</span><span class="p">,</span>
                <span class="s1">&#39;rewrite&#39;</span><span class="p">:</span> <span class="n">alg</span><span class="o">.</span><span class="n">rewritten</span><span class="p">,</span>
                <span class="s1">&#39;restrict&#39;</span><span class="p">:</span> <span class="n">alg</span><span class="o">.</span><span class="n">context_restricted</span><span class="p">,</span>
                <span class="s1">&#39;project&#39;</span><span class="p">:</span> <span class="n">_builtins_project_lambda</span><span class="p">,</span>
                <span class="s1">&#39;input&#39;</span><span class="p">:</span> <span class="n">_builtins_input_lambda</span><span class="p">,</span>
                <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="n">_builtins_output_lambda</span><span class="p">}</span>
    <span class="n">precedence</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;FUNC&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="s2">&quot;COMMA&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;PARAM&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;COMPOSE&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;UNION&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;INTERSECTION&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                  <span class="s2">&quot;MINUS&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;CONCAT&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;COMPLEMENT&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s2">&quot;STAR&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s2">&quot;PLUS&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s2">&quot;OPTIONAL&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s2">&quot;WEIGHT&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
                  <span class="s2">&quot;CP&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;CPOPTIONAL&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;RANGE&quot;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s2">&quot;CONTEXT&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;PAIRUP&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
    <span class="n">operands</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;SYMBOL&quot;</span><span class="p">,</span> <span class="s2">&quot;VARIABLE&quot;</span><span class="p">,</span> <span class="s2">&quot;ANY&quot;</span><span class="p">,</span> <span class="s2">&quot;EPSILON&quot;</span><span class="p">,</span> <span class="s2">&quot;CHAR_CLASS&quot;</span><span class="p">}</span>
    <span class="n">operators</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">precedence</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">unarypost</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;STAR&quot;</span><span class="p">,</span> <span class="s2">&quot;PLUS&quot;</span><span class="p">,</span> <span class="s2">&quot;WEIGHT&quot;</span><span class="p">,</span> <span class="s2">&quot;OPTIONAL&quot;</span><span class="p">,</span> <span class="s2">&quot;RANGE&quot;</span><span class="p">}</span>
    <span class="n">unarypre</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;COMPLEMENT&quot;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regularexpression</span><span class="p">,</span> <span class="n">defined</span><span class="p">,</span> <span class="n">functions</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tokenize, parse, and compile regex into FST.</span>
<span class="sd">        &#39;I define UNIX as 30 definitions of regular expressions living under one roof.&#39;</span>
<span class="sd">        - Don Knuth, Digital Typography, ch. 33, p. 649 (1999)&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">defined</span> <span class="o">=</span> <span class="n">defined</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">functions</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">}</span>  <span class="c1"># Who you gonna call?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expression</span> <span class="o">=</span> <span class="n">regularexpression</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tokenized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insert_invisibles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenize</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>

<div class="viewcode-block" id="RegexParse.character_class_parse">
<a class="viewcode-back" href="../../../pyfoma.private.html#pyfoma.private.regexparse.RegexParse.character_class_parse">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">character_class_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">charclass</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse a character class into range pairs, e.g. &#39;a-zA&#39; =&gt; [(97,122), (65,65)].</span>
<span class="sd">           &#39;Writing clear and unambiguous specifications for character classes is tough,</span>
<span class="sd">           and implementing them perfectly is worse, requiring a lot of tedious and</span>
<span class="sd">           uninstructive coding.&#39; -Brian Kernighan (in &quot;Beautiful Code&quot;, 2007). &quot;&quot;&quot;</span>

        <span class="n">negated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">charclass</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;^&#39;</span><span class="p">:</span>
            <span class="n">negated</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">charclass</span> <span class="o">=</span> <span class="n">charclass</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="n">clncc</span><span class="p">,</span> <span class="n">escaped</span> <span class="o">=</span> <span class="p">[],</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">charclass</span><span class="p">:</span>  <span class="c1"># remove escape chars and index those escaped positions</span>
            <span class="k">if</span> <span class="n">letter</span> <span class="o">!=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">:</span>
                <span class="n">clncc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">letter</span><span class="p">)</span>
                <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">escaped</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="c1"># Mark positions with a range (i.e. mark where the &quot;-&quot;-symbol is)</span>
        <span class="n">marks</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span> <span class="k">if</span> <span class="p">(</span><span class="n">clncc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span> <span class="ow">and</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">escaped</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> \
                          <span class="n">i</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">clncc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clncc</span><span class="p">))]</span>
        <span class="n">ranges</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">ord</span><span class="p">(</span><span class="n">clncc</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]),</span> <span class="nb">ord</span><span class="p">(</span><span class="n">clncc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clncc</span><span class="p">))</span> <span class="k">if</span> <span class="n">marks</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

        <span class="c1"># 3-convolve over marks to figure out where the non-range characters are</span>
        <span class="n">singles</span> <span class="o">=</span> <span class="p">[</span><span class="nb">any</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">marks</span><span class="p">,</span> <span class="n">marks</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="kc">False</span><span class="p">],</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">+</span> <span class="n">marks</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">singles</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">singles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">ranges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">ord</span><span class="p">(</span><span class="n">clncc</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="nb">ord</span><span class="p">(</span><span class="n">clncc</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>  <span class="c1"># dummy range, e.g (65, 65)</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">end</span> <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span><span class="s2">&quot;End must be larger than start in character class range.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ranges</span><span class="p">,</span> <span class="n">negated</span></div>


<div class="viewcode-block" id="RegexParse.compile">
<a class="viewcode-back" href="../../../pyfoma.private.html#pyfoma.private.regexparse.RegexParse.compile">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;FST&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Put it all together!</span>
<span class="sd">        &#39;If you lie to the compiler, it will have its revenge.&#39; â€” Henry Spencer.&quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_stackcheck</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_error_report</span><span class="p">(</span><span class="ne">SyntaxError</span><span class="p">,</span> <span class="s2">&quot;You stopped making sense!&quot;</span><span class="p">,</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">s</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_pop</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_stackcheck</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_peek</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>  <span class="c1"># For unaries we just directly mutate the FSM on top of the stack</span>
            <span class="k">return</span> <span class="n">_stackcheck</span><span class="p">(</span><span class="n">s</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_append</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">element</span><span class="p">])</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_merge</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>  <span class="c1"># since we keep the FSTs inside lists, we need to do some`</span>
            <span class="n">_stackcheck</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  <span class="c1"># reshuffling with a COMMA token so that the top 2 elements</span>
            <span class="n">one</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>  <span class="c1"># get merged into one list that ends up on top of the stack.</span>
            <span class="n">_stackcheck</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  <span class="c1"># [[FST1], [FST2], [FST3]] =&gt; [[FST1], [FST2, FST3]]</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="o">+</span> <span class="n">one</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_pairup</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>  <span class="c1"># take top two on stack and merge inside list as 2-tuple</span>
            <span class="n">_stackcheck</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  <span class="c1"># [ [FST1], [FST2], [FST3] ] =&gt; [ [FST1], [(FST2, FST3)] ]</span>
            <span class="n">one</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">_stackcheck</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">s</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">tuple</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="o">+</span> <span class="n">one</span><span class="p">)])</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_getargs</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_stackcheck</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="n">stack</span><span class="p">,</span> <span class="n">parameterstack</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;FUNC&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">functions</span><span class="p">:</span>  <span class="c1"># Look in user-defined functions first ...</span>
                    <span class="n">_append</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="n">value</span><span class="p">](</span><span class="o">*</span><span class="n">_getargs</span><span class="p">(</span><span class="n">stack</span><span class="p">),</span> <span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">parameterstack</span><span class="p">)))</span>
                <span class="k">elif</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builtins</span><span class="p">:</span>  <span class="c1"># ... then in built-ins</span>
                    <span class="n">_append</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">builtins</span><span class="p">[</span><span class="n">value</span><span class="p">](</span><span class="o">*</span><span class="n">_getargs</span><span class="p">(</span><span class="n">stack</span><span class="p">),</span> <span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">parameterstack</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_error_report</span><span class="p">(</span><span class="ne">SyntaxError</span><span class="p">,</span> <span class="s2">&quot;Function </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> \
                                       <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> not defined.&quot;</span><span class="p">,</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
                <span class="n">parameterstack</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;LPAREN&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_error_report</span><span class="p">(</span><span class="ne">SyntaxError</span><span class="p">,</span> <span class="s2">&quot;Missing closing parenthesis.&quot;</span><span class="p">,</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;COMMA&#39;</span><span class="p">:</span>  <span class="c1"># Collect arguments in single list on top of stack</span>
                <span class="n">_merge</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;PARAM&#39;</span><span class="p">:</span>
                <span class="n">parameterstack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;PAIRUP&#39;</span><span class="p">:</span>  <span class="c1"># Collect argument pairs as 2-tuples on top of stack</span>
                <span class="n">_pairup</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;CONTEXT&#39;</span><span class="p">:</span>  <span class="c1"># Same as COMMA, possible future expansion</span>
                <span class="n">_merge</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;UNION&#39;</span><span class="p">:</span>
                <span class="n">_append</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">_pop</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">_pop</span><span class="p">(</span><span class="n">stack</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;MINUS&#39;</span><span class="p">:</span>
                <span class="n">arg2</span><span class="p">,</span> <span class="n">arg1</span> <span class="o">=</span> <span class="n">_pop</span><span class="p">(</span><span class="n">stack</span><span class="p">),</span> <span class="n">_pop</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
                <span class="n">_append</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">arg1</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">arg2</span><span class="o">.</span><span class="n">determinize_unweighted</span><span class="p">()))</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;INTERSECTION&#39;</span><span class="p">:</span>
                <span class="n">_append</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">_pop</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">_pop</span><span class="p">(</span><span class="n">stack</span><span class="p">))</span><span class="o">.</span><span class="n">filter_coaccessible</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;CONCAT&#39;</span><span class="p">:</span>
                <span class="n">second</span> <span class="o">=</span> <span class="n">_pop</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
                <span class="n">_append</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">_pop</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">second</span><span class="p">)</span><span class="o">.</span><span class="n">filter_accessible</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;STAR&#39;</span><span class="p">:</span>
                <span class="n">_append</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">_pop</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span><span class="o">.</span><span class="n">kleene_closure</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;PLUS&#39;</span><span class="p">:</span>
                <span class="n">_append</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">_pop</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span><span class="o">.</span><span class="n">kleene_closure</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;plus&#39;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;COMPOSE&#39;</span><span class="p">:</span>
                <span class="n">arg2</span><span class="p">,</span> <span class="n">arg1</span> <span class="o">=</span> <span class="n">_pop</span><span class="p">(</span><span class="n">stack</span><span class="p">),</span> <span class="n">_pop</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
                <span class="n">_append</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">arg1</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="n">arg2</span><span class="p">)</span><span class="o">.</span><span class="n">filter_coaccessible</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;OPTIONAL&#39;</span><span class="p">:</span>
                <span class="n">_peek</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span><span class="o">.</span><span class="n">optional</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;RANGE&#39;</span><span class="p">:</span>
                <span class="n">rng</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">lang</span> <span class="o">=</span> <span class="n">_pop</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># e.g. {3}</span>
                    <span class="n">_append</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">alg</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                <span class="k">elif</span> <span class="n">rng</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>  <span class="c1"># e.g. {,3}</span>
                    <span class="n">lang</span> <span class="o">=</span> <span class="n">lang</span><span class="o">.</span><span class="n">optional</span><span class="p">()</span>
                    <span class="n">_append</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">alg</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">rng</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
                <span class="k">elif</span> <span class="n">rng</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>  <span class="c1"># e.g. {3,}</span>
                    <span class="n">_append</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">alg</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">rng</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                        <span class="n">lang</span><span class="o">.</span><span class="n">kleene_closure</span><span class="p">()))</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># e.g. {1,4}</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">rng</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">rng</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_error_report</span><span class="p">(</span><span class="ne">SyntaxError</span><span class="p">,</span> <span class="s2">&quot;n must be greater than m in {m,n}&quot;</span><span class="p">,</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
                    <span class="n">lang1</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">alg</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">rng</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="n">lang2</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">alg</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span>
                                             <span class="p">[</span><span class="n">lang</span><span class="o">.</span><span class="n">optional</span><span class="p">()]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">rng</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">rng</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                    <span class="n">_append</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">lang1</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">lang2</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;CP&#39;</span><span class="p">:</span>
                <span class="n">arg2</span><span class="p">,</span> <span class="n">arg1</span> <span class="o">=</span> <span class="n">_pop</span><span class="p">(</span><span class="n">stack</span><span class="p">),</span> <span class="n">_pop</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
                <span class="n">_append</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">arg1</span><span class="o">.</span><span class="n">cross_product</span><span class="p">(</span><span class="n">arg2</span><span class="p">)</span><span class="o">.</span><span class="n">filter_coaccessible</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;CPOPTIONAL&#39;</span><span class="p">:</span>
                <span class="n">arg2</span><span class="p">,</span> <span class="n">arg1</span> <span class="o">=</span> <span class="n">_pop</span><span class="p">(</span><span class="n">stack</span><span class="p">),</span> <span class="n">_pop</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
                <span class="n">_append</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">arg1</span><span class="o">.</span><span class="n">cross_product</span><span class="p">(</span><span class="n">arg2</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">filter_coaccessible</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;WEIGHT&#39;</span><span class="p">:</span>
                <span class="n">_peek</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="o">.</span><span class="n">push_weights</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;SYMBOL&#39;</span><span class="p">:</span>
                <span class="n">_append</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">FST</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="p">(</span><span class="n">value</span><span class="p">,)))</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;ANY&#39;</span><span class="p">:</span>
                <span class="n">_append</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">FST</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,)))</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;VARIABLE&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defined</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_error_report</span><span class="p">(</span><span class="ne">SyntaxError</span><span class="p">,</span> <span class="s2">&quot;Defined FST </span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> \
                                       <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> not found.&quot;</span><span class="p">,</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
                <span class="n">_append</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defined</span><span class="p">[</span><span class="n">value</span><span class="p">]</span><span class="o">.</span><span class="n">copy_mod</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;CHAR_CLASS&#39;</span><span class="p">:</span>
                <span class="n">charranges</span><span class="p">,</span> <span class="n">negated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">character_class_parse</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">_append</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">FST</span><span class="o">.</span><span class="n">character_ranges</span><span class="p">(</span><span class="n">charranges</span><span class="p">,</span> <span class="n">complement</span><span class="o">=</span><span class="n">negated</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;COMPLEMENT&#39;</span><span class="p">:</span>
                <span class="n">_append</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">_pop</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span><span class="o">.</span><span class="n">complement</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># If there&#39;s still stuff on the stack, that&#39;s a syntax error</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error_report</span><span class="p">(</span><span class="ne">SyntaxError</span><span class="p">,</span> \
                               <span class="s2">&quot;Something&#39;s happening here, and what it is ain&#39;t exactly clear...&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_pop</span><span class="p">(</span>
            <span class="n">stack</span><span class="p">)</span><span class="o">.</span><span class="n">trim</span><span class="p">()</span><span class="o">.</span><span class="n">epsilon_remove</span><span class="p">()</span><span class="o">.</span><span class="n">push_weights</span><span class="p">()</span><span class="o">.</span><span class="n">determinize_as_dfa</span><span class="p">()</span><span class="o">.</span><span class="n">minimize_as_dfa</span><span class="p">()</span><span class="o">.</span><span class="n">label_states_topology</span><span class="p">()</span><span class="o">.</span><span class="n">cleanup_sigma</span><span class="p">()</span></div>


<div class="viewcode-block" id="RegexParse.tokenize">
<a class="viewcode-back" href="../../../pyfoma.private.html#pyfoma.private.regexparse.RegexParse.tokenize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">tokenize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Token, token, token, though the stream is broken... ride &#39;em in, tokenize!&quot;&quot;&quot;</span>
        <span class="c1"># prematch (skip this), groupname, core regex (capture this), postmatch (skip)</span>
        <span class="n">token_regexes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s1">&#39;ESCAPED&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;&quot;</span><span class="p">),</span>  <span class="c1"># Esc&#39;d sym</span>
            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;, *&quot;</span><span class="p">,</span> <span class="s1">&#39;PARAM&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\w+ *= *[+-]? *\w+&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;&quot;</span><span class="p">),</span>  <span class="c1"># Parameter</span>
            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;QUOTED&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;&#39;|(</span><span class="se">\\</span><span class="s2">&#39;|[^&#39;])*&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;&#39;&quot;</span><span class="p">),</span>  <span class="c1"># Quoted sym</span>
            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s1">&#39;SKIPWS&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;[ \t]+&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;&quot;</span><span class="p">),</span>  <span class="c1"># Skip ws</span>
            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s1">&#39;SHORTOP&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;(:\?|[|\-&amp;*+()?:@,/_~])&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;&quot;</span><span class="p">),</span>  <span class="c1"># main ops</span>
            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\$\^&quot;</span><span class="p">,</span> <span class="s1">&#39;FUNC&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\w+&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;(?=\s*\()&quot;</span><span class="p">),</span>  <span class="c1"># Functions</span>
            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\$&quot;</span><span class="p">,</span> <span class="s1">&#39;VARIABLE&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\w+&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;&quot;</span><span class="p">),</span>  <span class="c1"># Variables</span>
            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s1">&#39;WEIGHT&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;[+-]?[0-9]*(\.[0-9]+)?&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;&gt;&quot;</span><span class="p">),</span>  <span class="c1"># Weight</span>
            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{&quot;</span><span class="p">,</span> <span class="s1">&#39;RANGE&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\d+,(\d+)?|,?\d+&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\}&quot;</span><span class="p">),</span>  <span class="c1"># {(m),(n)}</span>
            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[&quot;</span><span class="p">,</span> <span class="s1">&#39;CHAR_CLASS&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\^?(</span><span class="se">\\</span><span class="s2">]|[^\]])+&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\]&quot;</span><span class="p">),</span>  <span class="c1"># Char class</span>
            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s1">&#39;NEWLINE&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\n&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;&quot;</span><span class="p">),</span>  <span class="c1"># Line end</span>
            <span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s1">&#39;SYMBOL&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># Single sym</span>
        <span class="p">]</span>
        <span class="n">tok_regex</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(?P&lt;</span><span class="si">%s</span><span class="s1">&gt;</span><span class="si">%s</span><span class="s1">)</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mtch</span> <span class="k">for</span> <span class="n">mtch</span> <span class="ow">in</span> <span class="n">token_regexes</span><span class="p">)</span>
        <span class="n">line_num</span><span class="p">,</span> <span class="n">line_start</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mo</span> <span class="ow">in</span> <span class="n">pyre</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">tok_regex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="p">):</span>
            <span class="n">op</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">lastgroup</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
            <span class="n">column</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="o">-</span> <span class="n">line_start</span>
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;SKIPWS&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;ESCAPED&#39;</span> <span class="ow">or</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;QUOTED&#39;</span><span class="p">:</span>
                <span class="n">op</span> <span class="o">=</span> <span class="s1">&#39;SYMBOL&#39;</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;NEWLINE&#39;</span><span class="p">:</span>
                <span class="n">line_start</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
                <span class="n">line_num</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;SHORTOP&#39;</span><span class="p">:</span>
                <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shortops</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;PARAM&#39;</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">column</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">res</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_insert_invisibles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Idiot hack or genius? We insert explicit CONCAT tokens before parsing.</span>
<span class="sd">           &#39;I now avoid invisible infix operators almost entirely. I do remember a few</span>
<span class="sd">           texts dealing with theorems about strings in which concatenation was denoted</span>
<span class="sd">           by juxtaposition.&#39; (EWD 1300-9)&quot;&quot;&quot;</span>

        <span class="n">resetters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operators</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">unarypost</span>
        <span class="n">counter</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>  <span class="c1"># It&#39;s a two-state FST!</span>
            <span class="k">if</span> <span class="n">counter</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">token</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;LPAREN&#39;</span><span class="p">,</span> <span class="s1">&#39;COMPLEMENT&#39;</span><span class="p">}</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">operands</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;CONCAT&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">column</span><span class="p">))</span>
                <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">operands</span><span class="p">:</span>
                <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">resetters</span><span class="p">:</span>  <span class="c1"># No, really, it is!</span>
                <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">token</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">column</span><span class="p">))</span>
        <span class="c1"># Add epsilon to rewrites, restrict with missing contexts, .e.g &quot;(missing) _ #&quot;</span>
        <span class="n">newresult</span><span class="p">,</span> <span class="n">prevt</span> <span class="o">=</span> <span class="p">[],</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;COMMA&#39;</span> <span class="ow">or</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;PARAM&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">prevt</span> <span class="o">==</span> <span class="s1">&#39;PAIRUP&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;PAIRUP&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">prevt</span> <span class="o">==</span> <span class="s1">&#39;CONTEXT&#39;</span> <span class="ow">or</span> <span class="n">prevt</span> <span class="o">==</span> <span class="s1">&#39;COMMA&#39;</span><span class="p">))</span> <span class="ow">or</span> \
                    <span class="p">(</span><span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;RPAREN&#39;</span> <span class="ow">and</span> <span class="n">prevt</span> <span class="o">==</span> <span class="s1">&#39;PAIRUP&#39;</span><span class="p">):</span>
                <span class="n">newresult</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;SYMBOL&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">column</span><span class="p">))</span>
            <span class="n">newresult</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">token</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">column</span><span class="p">))</span>
            <span class="n">prevt</span> <span class="o">=</span> <span class="n">token</span>
        <span class="k">return</span> <span class="n">newresult</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_error_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errortype</span><span class="p">,</span> <span class="n">errorstring</span><span class="p">,</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">errortype</span><span class="p">(</span><span class="n">errorstring</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="p">))</span>

<div class="viewcode-block" id="RegexParse.parse">
<a class="viewcode-back" href="../../../pyfoma.private.html#pyfoma.private.regexparse.RegexParse.parse">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attention! Those who don&#39;t speak reverse Polish will be shunted!</span>
<span class="sd">        &#39;Simplicity is a great virtue but it requires hard work to achieve it and</span>
<span class="sd">        education to appreciate it. And to make matters worse: complexity sells better.&#39;</span>
<span class="sd">        - E. Dijkstra &quot;&quot;&quot;</span>
        <span class="n">output</span><span class="p">,</span> <span class="n">stack</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenized</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">operands</span> <span class="ow">or</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unarypost</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">token</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">column</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unarypre</span> <span class="ow">or</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;FUNC&quot;</span> <span class="ow">or</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;LPAREN&quot;</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">token</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">column</span><span class="p">))</span>
                <span class="c1"># if token == &quot;LPAREN&quot;:</span>
                <span class="c1">#    output.append(&quot;STARTP&quot;)</span>
            <span class="k">elif</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;RPAREN&quot;</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">stack</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_error_report</span><span class="p">(</span><span class="ne">SyntaxError</span><span class="p">,</span> <span class="s2">&quot;Too many closing parentheses.&quot;</span><span class="p">,</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;LPAREN&#39;</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
                <span class="c1"># output.append(&quot;ENDP&quot;)</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">stack</span> <span class="ow">and</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;FUNC&quot;</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">operators</span><span class="p">:</span>  <span class="c1"># We don&#39;t have any binaries that assoc right.</span>
                <span class="k">while</span> <span class="n">stack</span> <span class="ow">and</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">operators</span> <span class="ow">and</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">precedence</span><span class="p">[</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precedence</span><span class="p">[</span><span class="n">token</span><span class="p">]:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">token</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">column</span><span class="p">))</span>
        <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">output</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">PyFoma</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Mans Hulden and Michael Ginn.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.1</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>